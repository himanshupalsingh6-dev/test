<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Checkout â€“ QuickPress</title>
<link rel="stylesheet" href="css/style.css">

<!-- ðŸ”¥ FIREBASE INIT -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWTOu3JBhg3JuZg6snAxhnf_XFhLhLkbc",
    authDomain: "quickpress-web.firebaseapp.com",
    projectId: "quickpress-web",
    storageBucket: "quickpress-web.firebasestorage.app",
    messagingSenderId: "909067547966",
    appId: "1:909067547966:web:fda5e47e1e58ca7ae7a86f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
</script>
</head>

<body>

<h2 class="header">Checkout</h2>

<div class="card">

  <textarea id="address"
    placeholder="Enter delivery address"
    style="width:100%;padding:10px;"></textarea>

  <hr>

  <h3 style="display:flex;justify-content:space-between;">
    <span>Items Total</span>
    <span id="itemsTotal">â‚¹0</span>
  </h3>

  <h3 style="display:flex;justify-content:space-between;">
    <span>Delivery Charge</span>
    <span>â‚¹20</span>
  </h3>

  <h3 style="display:flex;justify-content:space-between;">
    <span>Handling Charge</span>
    <span>â‚¹3</span>
  </h3>

  <hr>

  <h2 style="display:flex;justify-content:space-between;">
    <span>Grand Total</span>
    <span id="checkoutTotal">â‚¹0</span>
  </h2>

  <button onclick="placeOrder()">Place Order</button>

</div>

<script src="js/cart.js"></script>

<script type="module">
  import { collection, addDoc, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  renderCheckoutPage();

  window.placeOrder = async function(){
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const address = document.getElementById("address").value;

    if(cart.length === 0){
      alert("Cart is empty");
      return;
    }
    if(!address){
      alert("Please enter address");
      return;
    }

    let itemsTotal = 0;
    cart.forEach(i => itemsTotal += i.price * i.qty);

    const delivery = 20;
    const handling = 3;
    const grandTotal = itemsTotal + delivery + handling;

    try{
      await addDoc(collection(window.db, "orders"), {
        items: cart,
        address: address,
        itemsTotal: itemsTotal,
        deliveryCharge: delivery,
        handlingCharge: handling,
        grandTotal: grandTotal,
        status: "Placed",
        createdAt: serverTimestamp()
      });

      localStorage.removeItem("cart");

      alert("Order placed successfully!");
      window.location.href = "index.html";

    }catch(e){
      console.error(e);
      alert("Order save failed");
    }
  };
</script>

</body>
</html>
