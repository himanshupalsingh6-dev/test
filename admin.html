<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuickPress ‚Äì Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --yellow:#FFD400;
  --bg:#f6f7f9;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
}
.header{
  padding:16px;
  background:#fff;
  font-size:20px;
  font-weight:900;
  box-shadow:0 2px 10px rgba(0,0,0,.1);
}
.page{padding:16px}
.card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.1);
}
.small{font-size:13px;color:#555}
.row{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
select,button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #ddd;
  font-weight:700;
}
button{
  background:var(--yellow);
  border:none;
  cursor:pointer;
}
button:disabled{opacity:.6}
.status{
  display:inline-block;
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:900;
}
.Placed{background:#ffe58a}
.Ready{background:#b7eb8f}
.Delivered{background:#91d5ff}
.Cancelled{background:#ffccc7}
.logout{
  text-align:center;
  margin:20px;
  font-weight:900;
  color:red;
  cursor:pointer;
}
.center{
  text-align:center;
  margin-top:60px;
  color:#555;
}
</style>
</head>

<body>

<div class="header">üõ†Ô∏è QuickPress Admin Panel</div>
<div class="page" id="orders"></div>
<div class="logout" onclick="logout()">üö™ Logout</div>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp, getApps } from
"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  updateDoc,
  orderBy,
  query
} from
"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAWTOu3JBhg3JuZg6snAxhnf_XFhLhLkbc",
  authDomain: "quickpress-web.firebaseapp.com",
  projectId: "quickpress-web"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ordersDiv = document.getElementById("orders");

/* ================= ADMIN AUTH GUARD ================= */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="customer-login.html";
    return;
  }

  // üîê CHECK ADMIN ROLE
  const adminRef = doc(db,"admins",user.uid);
  const adminSnap = await import(
    "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
  ).then(m => m.getDoc(adminRef));

  if(!adminSnap.exists()){
    alert("Access denied");
    location.href="index.html";
    return;
  }

  loadOrders();
});

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
  ordersDiv.innerHTML = "Loading orders...";

  try{
    const q = query(
      collection(db,"orders"),
      orderBy("createdAt","desc")
    );
    const snap = await getDocs(q);

    if(snap.empty){
      ordersDiv.innerHTML =
        `<div class="center">No orders found</div>`;
      return;
    }

    ordersDiv.innerHTML = "";

    snap.forEach(d=>{
      const o = d.data();

      const items = Array.isArray(o.items)
        ? o.items
        : Object.values(o.items || {});

      const itemsHtml = items.map(i=>
        `<div class="small">‚Ä¢ ${i.name} √ó ${i.qty}</div>`
      ).join("");

      ordersDiv.innerHTML += `
        <div class="card">
          <div class="row">
            <b>Order ID</b>
            <span class="small">${d.id}</span>
          </div>

          <div class="small">User: ${o.userId}</div>
          <div class="small">Address: ${o.address || "-"}</div>

          ${itemsHtml}

          <div class="row">
            <b>Total</b>
            <span>‚Çπ${o.grandTotal}</span>
          </div>

          <div class="row">
            <span class="status ${o.status}">${o.status}</span>
          </div>

          <div class="row">
            <select id="st-${d.id}">
              <option ${o.status==="Placed"?"selected":""}>Placed</option>
              <option ${o.status==="Ready"?"selected":""}>Ready</option>
              <option ${o.status==="Delivered"?"selected":""}>Delivered</option>
              <option ${o.status==="Cancelled"?"selected":""}>Cancelled</option>
            </select>

            <button onclick="updateStatus('${d.id}')">
              Update
            </button>
          </div>
        </div>
      `;
    });

  }catch(e){
    console.error(e);
    ordersDiv.innerHTML =
      `<div class="center">Failed to load orders</div>`;
  }
}

/* ================= UPDATE STATUS ================= */
window.updateStatus = async function(orderId){
  const sel = document.getElementById("st-"+orderId);
  const status = sel.value;

  try{
    await updateDoc(doc(db,"orders",orderId),{
      status: status
    });
    alert("Status updated to " + status);
  }catch(e){
    alert("Update failed");
    console.error(e);
  }
};

/* ================= LOGOUT ================= */
window.logout = async function(){
  await signOut(auth);
  location.href="index.html";
};
</script>

</body>
</html>
