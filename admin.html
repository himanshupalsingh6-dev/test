<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QuickPress – Admin Panel</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.navbar{display:flex;gap:16px;padding:12px;background:#FFD400;font-weight:900;overflow-x:auto}
.navbar span{cursor:pointer;white-space:nowrap}
.section{display:none;padding:12px}
.section.active{display:block}
.card{background:#fff;margin-bottom:12px;padding:14px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
button{padding:8px 14px;border:none;border-radius:8px;font-weight:800;cursor:pointer;margin-top:5px}
.accept{background:#2ecc71;color:#fff}
.reject{background:#e74c3c;color:#fff}
.assign{background:#3498db;color:#fff;width:100%}
select,input{padding:8px;margin:6px 0;width:100%;border-radius:6px}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  updateDoc, doc, onSnapshot, query, orderBy, where
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWTOu3JBhg3JuZg6snAxhnf_XFhLhLkbc",
  authDomain: "quickpress-web.firebaseapp.com",
  projectId: "quickpress-web"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* NAV */
window.show = id=>{
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

/* SOUND */
const bell = new Audio("sounds/order.mp3");
let soundEnabled = localStorage.getItem("soundEnabled")==="yes";
document.body.addEventListener("click",()=>{
  soundEnabled=true;
  localStorage.setItem("soundEnabled","yes");
});

/* ================= ORDERS ================= */
const ordersQuery = query(collection(db,"orders"),orderBy("createdAt","desc"));

onSnapshot(ordersQuery,snap=>{
  snap.docChanges().forEach(c=>{
    if(c.type==="added"){
      if(soundEnabled) bell.play();
      loadOrders();
      loadDashboard();
    }
  });
});

/* ================= PARTNER & DELIVERY OPTIONS ================= */
async function getPartnersOptions(){
  const snap = await getDocs(query(collection(db,"partners"), where("approved","==",true)));
  let html = `<option value="">Select Partner</option>`;
  snap.forEach(d=> html += `<option value="${d.id}">${d.data().name}</option>`);
  return html;
}

async function getDeliveryOptions(){
  const snap = await getDocs(query(collection(db,"delivery"), where("approved","==",true)));
  let html = `<option value="">Select Delivery</option>`;
  snap.forEach(d=> html += `<option value="${d.id}">${d.data().name}</option>`);
  return html;
}

/* ================= ASSIGN ================= */
window.assignPartner = async (orderId)=>{
  const pid = document.getElementById("partner_"+orderId).value;
  if(!pid){ alert("Select partner"); return; }
  await updateDoc(doc(db,"orders",orderId),{ partnerId: pid, status:"Assigned" });
  alert("Partner assigned");
};

window.assignDelivery = async (orderId)=>{
  const did = document.getElementById("delivery_"+orderId).value;
  if(!did){ alert("Select delivery"); return; }
  await updateDoc(doc(db,"orders",orderId),{ deliveryId: did, status:"Ready" });
  alert("Delivery assigned");
};

/* ================= STATUS ================= */
window.setStatus=(id,s)=>updateDoc(doc(db,"orders",id),{status:s});

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
  const box=document.getElementById("ordersList");
  box.innerHTML="";

  const partnerOptions = await getPartnersOptions();
  const deliveryOptions = await getDeliveryOptions();
  const snap=await getDocs(ordersQuery);

  snap.forEach(d=>{
    const o=d.data();
    let items="";
    o.items?.forEach(i=>items+=`${i.name} × ${i.qty}<br>`);

    box.innerHTML+=`
      <div class="card">
        <b>Order ID:</b> ${d.id}<br>
        ${items}
        <b>Total:</b> ₹${o.grandTotal || 0}<br>
        <b>Status:</b> ${o.status || "Placed"}<br><br>

        <!-- Partner Assign -->
        <select id="partner_${d.id}">${partnerOptions}</select>
        <button class="assign" onclick="assignPartner('${d.id}')">Assign Partner</button>

        <!-- Delivery Assign -->
        <select id="delivery_${d.id}">${deliveryOptions}</select>
        <button class="assign" onclick="assignDelivery('${d.id}')">Assign Delivery</button>

        <br><br>
        <button class="accept" onclick="setStatus('${d.id}','Accepted')">Accept</button>
        <button class="reject" onclick="setStatus('${d.id}','Rejected')">Reject</button>
      </div>
    `;
  });
}

/* ================= DASHBOARD ================= */
let statusChart,revenueChart;

function initCharts(){
  statusChart=new Chart(statusCanvas,{
    type:"pie",
    data:{labels:["Placed","Accepted","Rejected","Delivered"],datasets:[{data:[0,0,0,0],backgroundColor:["#3498db","#2ecc71","#e74c3c","#9b59b6"]}]}
  });

  revenueChart=new Chart(revenueCanvas,{
    type:"line",
    data:{labels:[],datasets:[{label:"Revenue",data:[],borderColor:"#27ae60",fill:false,tension:.3}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}

async function loadDashboard(){
  const snap=await getDocs(collection(db,"orders"));
  let totalOrders=0,todayOrders=0,totalRevenue=0;
  let statusCount={Placed:0,Accepted:0,Rejected:0,Delivered:0};
  let revenueByDay={};
  const todayStr=new Date().toISOString().slice(0,10);

  snap.forEach(d=>{
    const o=d.data(); totalOrders++;
    const amount=Number(o.grandTotal)||0; totalRevenue+=amount;
    if(o.status && statusCount[o.status]!=null) statusCount[o.status]++;
    let dateKey=todayStr;
    if(o.createdAt?.seconds) dateKey=new Date(o.createdAt.seconds*1000).toISOString().slice(0,10);
    if(dateKey===todayStr) todayOrders++;
    revenueByDay[dateKey]=(revenueByDay[dateKey]||0)+amount;
  });

  totalOrders.innerText=totalOrders;
  todayOrders.innerText=todayOrders;
  totalRevenue.innerText=totalRevenue;

  statusChart.data.datasets[0].data=[statusCount.Placed,statusCount.Accepted,statusCount.Rejected,statusCount.Delivered];
  statusChart.update();

  const days=Object.keys(revenueByDay).sort().slice(-7);
  revenueChart.data.labels=days;
  revenueChart.data.datasets[0].data=days.map(d=>revenueByDay[d]);
  revenueChart.update();
}

/* ================= REGISTRATION ================= */
window.addPartner = async ()=>{
  await addDoc(collection(db,"partners"),{
    name: partnerName.value,
    email: partnerEmail.value,
    password: partnerPassword.value,
    approved:true,
    wallet:0
  });
  alert("Partner registered");
};

window.addDelivery = async ()=>{
  await addDoc(collection(db,"delivery"),{
    name: deliveryName.value,
    email: deliveryEmail.value,
    password: deliveryPassword.value,
    approved:true,
    wallet:0
  });
  alert("Delivery boy registered");
};

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  initCharts();
  loadOrders();
  loadDashboard();
});
</script>
</head>

<body>

<div class="navbar">
  <span onclick="show('dashboard')">Dashboard</span>
  <span onclick="show('orders')">Orders</span>
  <span onclick="show('partners')">Partners</span>
  <span onclick="show('delivery')">Delivery</span>
</div>

<div id="dashboard" class="section active">
  <div class="card">
    Total Orders: <span id="totalOrders">0</span><br>
    Today Orders: <span id="todayOrders">0</span><br>
    Total Revenue: ₹<span id="totalRevenue">0</span>
  </div>
  <div class="card"><canvas id="statusCanvas"></canvas></div>
  <div class="card"><canvas id="revenueCanvas"></canvas></div>
</div>

<div id="orders" class="section"><div id="ordersList"></div></div>

<div id="partners" class="section">
  <div class="card">
    <input id="partnerName" placeholder="Partner Name">
    <input id="partnerEmail" placeholder="Partner Email">
    <input id="partnerPassword" placeholder="Password">
    <button onclick="addPartner()">Register Partner</button>
  </div>
</div>

<div id="delivery" class="section">
  <div class="card">
    <input id="deliveryName" placeholder="Delivery Boy Name">
    <input id="deliveryEmail" placeholder="Delivery Email">
    <input id="deliveryPassword" placeholder="Password">
    <button onclick="addDelivery()">Register Delivery</button>
  </div>
</div>
<!DOCTYPE html>
<html>
<head>
  <title>Admin</title>
</head>
<body>

<h1>Admin Panel</h1>
<div id="orders"></div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyAWTOu3JBhg3JuZg6snAxhnf_XFhLhLkbc",
  authDomain: "quickpress-web.firebaseapp.com",
  projectId: "quickpress-web"
});

const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth,async(user)=>{
  if(!user) location.href="customer-login.html";
  const snap = await getDoc(doc(db,"admins",user.uid));
  if(!snap.exists()) location.href="index.html";
});
</script>

<script type="module" src="js/admin-orders.js"></script>
</body>
</html>

</body>
</html>
