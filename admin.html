<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QuickPress â€“ Admin Panel</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
.navbar{
  display:flex;
  gap:16px;
  padding:12px;
  background:#FFD400;
  font-weight:900;
  overflow-x:auto;
}
.navbar span{cursor:pointer;white-space:nowrap}
.section{display:none;padding:12px}
.section.active{display:block}

.card{
  background:#fff;
  margin-bottom:12px;
  padding:14px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
button{
  padding:8px 14px;border:none;border-radius:8px;
  font-weight:800;cursor:pointer;margin-right:6px
}
.accept{background:#2ecc71;color:#fff}
.reject{background:#e74c3c;color:#fff}
input{padding:8px;margin:4px;width:90%}
</style>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc,
  updateDoc, doc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAWTOu3JBhg3JuZg6snAxhnf_XFhLhLkbc",
  authDomain: "quickpress-web.firebaseapp.com",
  projectId: "quickpress-web"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= NAV ================= */
window.show = id=>{
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

/* ================= ðŸ”” BELL ================= */
const bell = new Audio("sounds/order.mp3");
let soundEnabled = localStorage.getItem("soundEnabled")==="yes";
document.body.addEventListener("click",()=>{
  soundEnabled=true;
  localStorage.setItem("soundEnabled","yes");
});

/* ================= ORDERS ================= */
const ordersQuery = query(collection(db,"orders"),orderBy("createdAt","desc"));

onSnapshot(ordersQuery,snap=>{
  snap.docChanges().forEach(c=>{
    if(c.type==="added"){
      if(soundEnabled) bell.play();
      loadOrders();
      loadDashboard();
    }
  });
});

async function loadOrders(){
  const box=document.getElementById("ordersList");
  box.innerHTML="";
  const snap=await getDocs(ordersQuery);
  snap.forEach(d=>{
    const o=d.data();
    let items="";
    o.items?.forEach(i=>items+=`${i.name} Ã— ${i.qty}<br>`);
    box.innerHTML+=`
      <div class="card">
        <b>Order ID:</b> ${d.id}<br>
        ${items}
        <b>Total:</b> â‚¹${o.grandTotal}<br>
        <b>Status:</b> ${o.status}<br><br>
        <button class="accept" onclick="setStatus('${d.id}','Accepted')">Accept</button>
        <button class="reject" onclick="setStatus('${d.id}','Rejected')">Reject</button>
      </div>`;
  });
}
window.setStatus=(id,s)=>updateDoc(doc(db,"orders",id),{status:s});

/* ================= DASHBOARD ================= */
let statusChart,revenueChart;

function initCharts(){
  statusChart=new Chart(statusCanvas,{
    type:"pie",
    data:{
      labels:["Placed","Accepted","Rejected","Delivered"],
      datasets:[{data:[0,0,0,0],
        backgroundColor:["#3498db","#2ecc71","#e74c3c","#9b59b6"]}]
    }
  });

  revenueChart=new Chart(revenueCanvas,{
    type:"line",
    data:{labels:[],datasets:[{
      label:"Revenue",
      data:[],borderColor:"#27ae60",fill:false
    }]}
  });
}

async function loadDashboard(){
  const snap=await getDocs(collection(db,"orders"));
  let totalOrders=0,todayOrders=0,totalRevenue=0;
  let statusCount={Placed:0,Accepted:0,Rejected:0,Delivered:0};
  let revenueByDay={};
  const today=new Date().toDateString();

  snap.forEach(d=>{
    const o=d.data();
    totalOrders++;
    totalRevenue+=o.grandTotal||0;
    if(o.status && statusCount[o.status]!=null) statusCount[o.status]++;
    if(o.createdAt){
      const day=new Date(o.createdAt.seconds*1000).toDateString();
      if(day===today) todayOrders++;
      revenueByDay[day]=(revenueByDay[day]||0)+(o.grandTotal||0);
    }
  });

  totalOrdersEl.innerText=totalOrders;
  todayOrdersEl.innerText=todayOrders;
  totalRevenueEl.innerText=totalRevenue;

  statusChart.data.datasets[0].data=[
    statusCount.Placed,statusCount.Accepted,
    statusCount.Rejected,statusCount.Delivered
  ];
  statusChart.update();

  const days=Object.keys(revenueByDay).slice(-7);
  revenueChart.data.labels=days;
  revenueChart.data.datasets[0].data=days.map(d=>revenueByDay[d]);
  revenueChart.update();
}

/* ================= SIMPLE CRUD ================= */
window.addProduct=()=>addDoc(collection(db,"products"),{name:pname.value,price:+pprice.value});
window.addPartner=()=>addDoc(collection(db,"partners"),{name:partner.value,approved:false});
window.addDelivery=()=>addDoc(collection(db,"delivery"),{name:delivery.value,approved:false});
window.addWallet=()=>addDoc(collection(db,"wallet"),{user:walletUser.value,amount:+walletAmt.value});

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  initCharts();
  loadOrders();
  loadDashboard();
});
</script>
</head>

<body>

<div class="navbar">
  <span onclick="show('dashboard')">Dashboard</span>
  <span onclick="show('orders')">Orders</span>
  <span onclick="show('products')">Products</span>
  <span onclick="show('partners')">Partners</span>
  <span onclick="show('delivery')">Delivery</span>
  <span onclick="show('wallet')">Wallet</span>
</div>

<div id="dashboard" class="section active">
  <div class="card">
    Total Orders: <span id="totalOrders">0</span><br>
    Today Orders: <span id="todayOrders">0</span><br>
    Total Revenue: â‚¹<span id="totalRevenue">0</span>
  </div>
  <div class="card"><canvas id="statusCanvas"></canvas></div>
  <div class="card"><canvas id="revenueCanvas"></canvas></div>
</div>

<div id="orders" class="section"><div id="ordersList"></div></div>

<div id="products" class="section">
  <div class="card">
    <input id="pname" placeholder="Product name">
    <input id="pprice" placeholder="Price">
    <button onclick="addProduct()">Add Product</button>
  </div>
</div>

<div id="partners" class="section">
  <div class="card">
    <input id="partner" placeholder="Partner name">
    <button onclick="addPartner()">Add Partner</button>
  </div>
</div>

<div id="delivery" class="section">
  <div class="card">
    <input id="delivery" placeholder="Delivery boy name">
    <button onclick="addDelivery()">Add Delivery</button>
  </div>
</div>

<div id="wallet" class="section">
  <div class="card">
    <input id="walletUser" placeholder="User">
    <input id="walletAmt" placeholder="Amount">
    <button onclick="addWallet()">Add Wallet</button>
  </div>
</div>

</body>
</html>
